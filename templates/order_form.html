{% extends "layout.html" %}
{% block content %}
  <form method="post" action="{{ url_for('create_order.create_order') }}">
    <label>Customer *
      <select name="customer_id" required>
        <option value="">-- Select customer --</option>
        {% for customer in customers %}
        <option value="{{ customer.customer_id }}">
          {{ customer.full_name }} ({{ customer.phone_number }})
        </option>
        {% endfor %}
      </select>
    </label>
    
    <label>Postal Code *
      <input type="text" name="postal_code" value="{{ request.form.postal_code or '' }}" required>
    </label>

    <label>Delivery Address *
      <textarea name="delivery_address" rows="2" required>{{ request.form.delivery_address or '' }}</textarea>
    </label>
    
    <label>Discount Code (Optional)
      <select name="discount_id">
        <option value="">-- No discount --</option>
        {% for discount in discount_codes %}
        <option value="{{ discount.discount_id }}">
          {{ discount.discount_code }} ({{ discount.percentage }}% off)
        </option>
        {% endfor %}
      </select>
    </label>

    <h3>Select Items</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for item in menu_items %}
        <tr>
          <td>{{ item.name }}</td>
          <td>€ {{ '%.2f'|format(item.price) }}</td>
          <td>
            <input type="number" name="item_{{ item.item_id }}" min="0"
                   value="{{ request.form['item_' ~ item.item_id] or 0 }}">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p>
      <button class="btn btn-secondary" type="submit" name="action" value="preview">Calculate Price</button>
      <button class="btn btn-primary" type="submit" name="action" value="create">Place Order</button>
    </p>
  </form>

  {% if total is defined %}
    <hr>
    <h3>Price Preview</h3>
    <p>Subtotal: € {{ '%.2f'|format(raw_price) }}</p>

    {% if messages %}
      <p>Discounts applied:</p>
      <ul>
        {% for msg in messages %}
          <li>{{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <h3>Total: € {{ '%.2f'|format(total) }}</h3>
  {% endif %}
{% endblock %}
