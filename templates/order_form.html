{% extends "layout.html" %}
{% block content %}
  <form method="post" action="{{ url_for('create_order.create_order') }}">
    <label>Customer *
      <select name="customer_id" required>
        <option value="">-- Select customer --</option>
        {% for customer in customers %}
          <option value="{{ customer.customer_id }}"
            {% if request.form.get('customer_id') == customer.customer_id|string %}selected{% endif %}>
            {{ customer.full_name }}
          </option>
        {% endfor %}
      </select>
    </label>
    
    <label>Use address and postal code from selected customer
      <input type="checkbox" name="use_customer_address" id="use_customer_address"
             {% if request.form.get("use_customer_address") %} checked{% endif %}>
    </label>
    
    <label>Postal Code
      <input type="text" name="postal_code" value="{{ request.form.postal_code or '' }}">
    </label>

    <label>Delivery Address
      <textarea name="delivery_address" rows="2" >{{ request.form.delivery_address or '' }}</textarea>
    </label>
    
    <label>Discount Code (Optional)
        <textarea name="discount_code" rows="1" >{{ request.form.discount_code or '' }}</textarea>
    </label>

    <h3>Select Items</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for item in menu_items %}
        <tr>
          <td>{{ item.name }}</td>
          <td>€ {{ '%.2f'|format(item.price) }}</td>
          <td>
            <input type="number" name="item_{{ item.item_id }}" min="0"
                   value="{{ request.form['item_' ~ item.item_id] or 0 }}">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p>
      <button class="btn btn-secondary" type="submit" name="action" value="preview">Calculate Price</button>
      <button class="btn btn-primary" type="submit" name="action" value="create">Place Order</button>
    </p>
  </form>

  {% if total is defined %}
    <hr>
    <h3>Price Preview</h3>
    <p>Subtotal: € {{ '%.2f'|format(raw_price) }}</p>

    {% if messages %}
      <p>Discounts applied:</p>
      <ul>
        {% for msg in messages %}
          <li>{{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <h3>Total: € {{ '%.2f'|format(total) }}</h3>
  {% endif %}
{% endblock %}
